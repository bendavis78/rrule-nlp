<script src="../bower_components/chrono/chrono.min.js"></script>
<script src="../bower_components/moment/min/moment.min.js"></script>
<script src="../bower_components/rrule/lib/rrule.js"></script>
<script src="../bower_components/rrule/lib/nlp.js"></script>

<script src="../rrule-nlp.js"></script>
<script src="phrases.js"></script>

<script>
  /* globals rrule: false, chrono: false */
  var phrase, expected, result, i, k;

  function logResult(errors, result) {
    var rfcString, verbose;
    errors = errors || [];
    try {
      rfcString = result.toRFCString();
      verbose = result.toString();
    } catch (e) {
      rfcString = null;
      verbose = null;
      errors.push(e);
    }
    if (errors.length) {
      console.groupCollapsed('%cFailed: ' + phrase, 'color: red');
      for (var e=0; e<errors.length; e++) {
        if (errors[e].key) {
          console.group(errors[e].key);
          console.log('Expected: ', serialize(errors[e].expected));
          console.log('Result: ', serialize(errors[e].result));
          console.log(result);
          console.groupEnd();
        } else if (errors[e] instanceof Error) {
          console.error(errors[e].stack);
        } else {
          console.error.apply(console, errors[e]);
        }
      }
      console.groupEnd();
    } else {
      console.group('%cSuccess: ' + phrase, 'color: green');
      console.log('%c' + rfcString, 'color: blue');
      console.log('%c' + verbose, 'color: #333');
      //console.log('Result: ', result);
      console.groupEnd();
    }
  }

  function serialize(obj) {
    if (obj instanceof String || obj instanceof Number) {
      return obj;
    }
    if (obj instanceof Date) {
      return obj.getTime();
    }
    return JSON.stringify(obj);
  }

  function cmp(expected, result) {
    expected = serialize(expected);
    result = serialize(result);
    return expected == result;
  }

  var errors, chkResult, chkValue;

  var opts = {
    refDate: new Date(2015, 0, 1, 12, 0),
    preferFuture: true
  };

  for (i=0; i<window.phrases.length; i++) {
    phrase = window.phrases[i][0];
    expected = window.phrases[i][1];
    errors = [];

    try {
      result = rrule.parse(phrase, opts);
      if (!(result instanceof rrule.Event)) {
        throw new Error('result is not a Event object');
      }
    } catch (e) {
      if (expected !== null) {
        errors.push(e);
      }
      logResult(errors);
      continue;
    }
    if (typeof(expected) === 'object') {
      for (k in expected) {
        chkResult = result.rrule || {};
        if (/dt(start|end)/.test(k)) {
          chkResult = result;
        }
        chkValue = chkResult[k];
        if (chkValue instanceof chrono.ParsedComponents) {
          chkValue = chkResult.componentToRFCString(k);
        }
        if (!cmp(expected[k], chkValue)) {
          errors.push({key: k, expected: expected[k], result: chkValue});
        }
      }
    } else {
      errors.push(['TODO: handle ', expected, result]);
    }

    logResult(errors, result);
  }

  for (var i=0; i<window.phrases.length; i++) {
    phrase = window.phrases[i][0];
    result = rrule.parse(phrase);
  }
</script>

<p>See JavaScript console for test results.</p>
